from angr import sim_options as so
import angr

from bin_check.tracing import get_funcs_and_prj
from bin_check.celery_app import do_trace, fix_sys_bugs


def test_detect_injection():
    test_file = "examples/upload.cgi"
    mtd_write_bootloader = 0x00401338

    funcs, proj = get_funcs_and_prj(test_file, True, False)

    assert len(funcs) > 0

    addr, cmd = do_trace(proj, mtd_write_bootloader)

    assert addr is not None
    assert cmd is not None

def test_detect_format():
    test_file = "examples/medium_format"
    main = 0x08048583

    funcs, proj = get_funcs_and_prj(test_file, False, True)

    assert len(funcs) > 0

    addr, cmd = do_trace(proj, main)

    assert addr is not None
    assert cmd is not None